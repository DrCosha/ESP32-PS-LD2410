# ESP32-PS-LD2410
**Firware for ESP32s module with presence sensor HLK-LD2410.**

**Модуль присутствия/движения на ESP32s и модуле HLK-LD2410.**  

Позволяет обнаруживать движущиеся и неподвижные объекты на расстоянии до __5 метров__. Датчик LD2410 может быть дополнительно настроен на различную чувствительность в зависимости от расстояния до объекта.
На плате есть дополнительный разъем OUT1, на который выведены выходы ключей с открытым коллектором, для подключения внешней перефирии.  Выходы `Ext1` и `Ext2` дублируют сигналы обнаружения подвижного и
неподвижного объекта в зоне обнаружения датчика.
Для сопряжения с системой "умного дома", модуль соединяется по WiFi с MQTT сервером. Настройки подключения прошиваются в подключаемом файле <local.h>. При отсутсвии этого файла, настройки могут быть взяты из 
основного тела программы (закомментированные строки).
Общение с датчиком через MQTT происходит через два топика __[SET]__ и __[STATUS]__. В топик __[STATUS]__ датчик рапортует о своём состоянии. Для режима ожидания - каждые __60__ секунд. При обнаружении объекта - в момент события 
и далее с интервалом в __3__ секунды.

Общая тревога по датчику снимается через __120__ секунд (тег "alert").  Последнее время задается в настройках модуля LD2410, и может быть настроено без программирования ESP32s.

Если модуль получает в топике __[SET]__ команду `{report}`, то сразу публикует в топике __[STATUS]__ своё текущее состояние. 

**Примеры сообщений:**

Пример отчета для датчика в активном состоянии в топике __[STATUS]__:

```

{"alert":"ON","moving":"ON","moving_distance":44,"moving_energy":100,"presence":"ON","presence_distance":57,"presence_energy":100}

```

Пример отчета для датчика в режиме ожидания в топике __[STATUS]__:

```

{"alert":"OFF","moving":"OFF","moving_distance":0,"moving_energy":0,"presence":"OFF","presence_distance":0,"presence_energy":0}

```

Общая принципиальная схема модуля представлена ниже.

![Schematic_ESP32-PS-HLK-LD2410 rev1_2023-11-01](https://github.com/DrCosha/ESP32-PS-LD2410/assets/80087552/bc56a9ed-4f1f-4886-a324-9e1ee202fa6d)
